<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ERCOT Grid Analytics</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #0a0b0d; color: #ffffff; line-height: 1.6; }
        
        .header { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(20px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding: 1rem 0; position: sticky; top: 0; z-index: 100; }
        .nav { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 2rem; }
        .logo { font-size: 1.5rem; font-weight: 700; color: #00d4ff; }
        .nav-links { display: flex; list-style: none; gap: 2rem; align-items: center; }
        .nav-links a { color: #cbd5e1; text-decoration: none; font-weight: 500; padding: 0.5rem 1rem; border-radius: 8px; transition: all 0.3s ease; }
        .nav-links a:hover { color: #00d4ff; background: rgba(0, 212, 255, 0.1); }
        
        .auth-section { display: flex; gap: 1rem; align-items: center; }
        .auth-btn { background: linear-gradient(135deg, #9333ea 0%, #00d4ff 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; }
        .auth-btn:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(147, 51, 234, 0.3); }
        .user-info { color: #94a3b8; font-size: 0.9rem; }
        .logout-btn { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; }
        .dashboard-controls { background: rgba(147, 51, 234, 0.1); border: 1px solid rgba(147, 51, 234, 0.3); color: #a855f7; margin-left: 1rem; }
        
        .hero { text-align: center; padding: 3rem 2rem 2rem; background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%); }
        .hero h1 { font-size: 3rem; font-weight: 800; margin-bottom: 1rem; background: linear-gradient(135deg, #00d4ff 0%, #9333ea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .hero p { font-size: 1.2rem; color: #94a3b8; margin-bottom: 2rem; max-width: 600px; margin-left: auto; margin-right: auto; }
        .status-indicator { display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(34, 197, 94, 0.1); padding: 0.5rem 1rem; border-radius: 20px; border: 1px solid rgba(34, 197, 94, 0.3); font-size: 0.9rem; }
        .status-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .dashboard-container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        .section-title { font-size: 2rem; font-weight: 700; margin-bottom: 1.5rem; color: #f1f5f9; display: flex; justify-content: space-between; align-items: center; }
        .dashboard-actions { display: flex; gap: 1rem; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem; }
        
        /* Chart card styles */
        .chart-card { 
            background: rgba(15, 23, 42, 0.6); 
            border-radius: 16px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 1.5rem; 
            backdrop-filter: blur(20px); 
            transition: all 0.3s ease; 
            position: relative; 
            min-height: 580px;
            resize: both;
            overflow: hidden;
            min-width: 300px;
        }
        
        .chart-card.hidden { display: none; }
        .chart-card:hover { border-color: rgba(0, 212, 255, 0.3); transform: translateY(-2px); box-shadow: 0 20px 40px rgba(0, 212, 255, 0.1); }
        .chart-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        
        .chart-controls { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; }
        .chart-controls button { 
            background: rgba(34, 197, 94, 0.1); 
            border: 1px solid rgba(34, 197, 94, 0.3); 
            color: #22c55e; 
            padding: 0.25rem 0.5rem; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 0.7rem; 
            transition: all 0.2s ease; 
        }
        .chart-controls button:hover { background: rgba(34, 197, 94, 0.2); }
        .chart-controls .fullscreen-btn { background: rgba(0, 212, 255, 0.1); border-color: rgba(0, 212, 255, 0.3); color: #00d4ff; }
        .chart-controls .hide-btn { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: #ef4444; }
        .chart-controls .save-size-btn { background: rgba(147, 51, 234, 0.1); border-color: rgba(147, 51, 234, 0.3); color: #a855f7; }
        
        .iframe-container { 
            position: relative; 
            width: 100%; 
            height: calc(100% - 4rem); 
            border-radius: 8px; 
            overflow: hidden; 
            background: rgba(30, 41, 59, 0.5); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }
        .iframe-container iframe { width: 100%; height: 100%; border: none; border-radius: 8px; background: transparent; }
        .full-width-chart { grid-column: 1 / -1; }
        
        .ai-card { background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(0, 212, 255, 0.1) 100%); }
        .ai-card-content { padding: 2rem; text-align: center; }
        .ai-icon { font-size: 3rem; margin-bottom: 1rem; }
        .ai-placeholder h4 { color: #e2e8f0; margin-bottom: 1rem; font-size: 1.5rem; }
        .ai-placeholder p { color: #94a3b8; margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto; }
        .ai-create-btn { background: linear-gradient(135deg, #9333ea 0%, #00d4ff 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 8px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .ai-create-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(147, 51, 234, 0.3); }
        
        .ai-btn { background: rgba(147, 51, 234, 0.2); border: 1px solid rgba(147, 51, 234, 0.3); color: #a855f7; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem; transition: all 0.2s ease; text-decoration: none; }
        .ai-btn:hover { background: rgba(147, 51, 234, 0.3); }
        
        .clear-btn { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.7rem; transition: all 0.2s ease; }
        .clear-btn:hover { background: rgba(239, 68, 68, 0.2); }
        
        .footer { background: rgba(15, 23, 42, 0.8); border-top: 1px solid rgba(255, 255, 255, 0.1); padding: 2rem; text-align: center; color: #64748b; }
        
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); }
        .modal-content { background: rgba(15, 23, 42, 0.95); margin: 5% auto; padding: 2rem; border-radius: 16px; border: 1px solid rgba(255, 255, 255, 0.1); width: 90%; max-width: 800px; backdrop-filter: blur(20px); max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #00d4ff; }
        
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: #e2e8f0; font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.75rem; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(30, 41, 59, 0.5); color: #ffffff; font-size: 1rem; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #00d4ff; box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1); }
        
        .form-tabs { display: flex; margin-bottom: 2rem; background: rgba(30, 41, 59, 0.5); border-radius: 8px; }
        .tab-btn { flex: 1; padding: 0.75rem; border: none; background: transparent; color: #94a3b8; cursor: pointer; transition: all 0.3s ease; }
        .tab-btn.active { background: rgba(0, 212, 255, 0.1); color: #00d4ff; }
        
        .panel-settings { background: rgba(30, 41, 59, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .panel-settings h4 { color: #e2e8f0; margin-bottom: 0.5rem; }
        .panel-settings .panel-type { color: #00d4ff; font-size: 0.8rem; margin-bottom: 0.5rem; }
        .panel-toggle { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .panel-toggle input[type="checkbox"] { transform: scale(1.2); }
        
        .error-message { color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem; }
        .success-message { color: #22c55e; font-size: 0.9rem; margin-top: 0.5rem; }
        
        .panels-tabs { display: flex; margin-bottom: 1rem; background: rgba(30, 41, 59, 0.5); border-radius: 8px; }
        .panels-tab-btn { flex: 1; padding: 0.5rem; border: none; background: transparent; color: #94a3b8; cursor: pointer; transition: all 0.3s ease; font-size: 0.9rem; }
        .panels-tab-btn.active { background: rgba(0, 212, 255, 0.1); color: #00d4ff; }
        
        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .hero h1 { font-size: 2rem; }
            .dashboard-container { padding: 1rem; }
            .chart-card { min-height: 400px; }
            .nav { padding: 0 1rem; }
            .nav-links { gap: 1rem; }
        }
    </style>
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">‚ö° ERCOT Analytics</div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="http://52.4.166.16:3000" target="_blank">Full Dashboard</a></li>
                <li><a href="#" onclick="loadDocs(); return false;">API</a></li>
                <div class="auth-section" id="authSection">
                    <button class="auth-btn" onclick="showAuthModal('login')">Login</button>
                    <button class="auth-btn" onclick="showAuthModal('register')">Sign Up</button>
                </div>
            </ul>
        </nav>
    </header>

    <section class="hero">
        <h1>Texas Grid Analytics</h1>
        <p>Real-time monitoring and analysis of ERCOT's electrical grid capacity, reserves, and operational status</p>
        <div class="status-indicator">
            <div class="status-dot"></div>
            System Operational - Live Data
        </div>
    </section>

    <main class="dashboard-container">
        <section>
            <div class="section-title">
                <span id="dashboardTitle">Live Grid Monitoring</span>
                <div class="dashboard-actions" id="dashboardActions" style="display: none;">
                    <button class="auth-btn dashboard-controls" onclick="showDashboardModal()">‚öôÔ∏è Customize</button>
                    <button class="auth-btn dashboard-controls" onclick="resetDashboard()">üîÑ Reset</button>
                </div>
            </div>
            
            <!-- Dynamic charts will be inserted here -->
            <div id="chartsContainer"></div>
        </section>
    </main>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAuthModal()">&times;</span>
            
            <div class="form-tabs">
                <button class="tab-btn active" id="loginTab" onclick="switchTab('login')">Login</button>
                <button class="tab-btn" id="registerTab" onclick="switchTab('register')">Sign Up</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" style="display: block;">
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="auth-btn" style="width: 100%; margin: 0;">Login</button>
                <div id="loginMessage"></div>
            </form>

            <!-- Register Form -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerUsername">Username</label>
                    <input type="text" id="registerUsername" required>
                </div>
                <div class="form-group">
                    <label for="registerFirstName">First Name</label>
                    <input type="text" id="registerFirstName">
                </div>
                <div class="form-group">
                    <label for="registerLastName">Last Name</label>
                    <input type="text" id="registerLastName">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="auth-btn" style="width: 100%; margin: 0;">Sign Up</button>
                <div id="registerMessage"></div>
            </form>
        </div>
    </div>

    <!-- Dashboard Customization Modal -->
    <div id="dashboardModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeDashboardModal()">&times;</span>
            
            <h3 style="color: #e2e8f0; margin-bottom: 1rem;">‚öôÔ∏è Customize Personal Dashboard</h3>
            
            <div class="panels-tabs">
                <button class="panels-tab-btn active" id="predefinedTab" onclick="switchPanelsTab('predefined')">üìä ERCOT Charts</button>
                <button class="panels-tab-btn" id="aiGeneratedTab" onclick="switchPanelsTab('ai_generated')">ü§ñ AI Generated</button>
            </div>
            
            <div id="predefinedPanels" style="display: block;"></div>
            <div id="aiGeneratedPanels" style="display: none;"></div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button class="auth-btn" onclick="saveDashboardSettings()" style="flex: 1;">Save Settings</button>
                <button class="auth-btn logout-btn" onclick="resetDashboard()" style="flex: 1;">Reset to Default</button>
            </div>
            
            <div id="dashboardMessage"></div>
        </div>
    </div>

    <!-- AI Visualization Modal -->
    <div id="aiModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAIModal()">&times;</span>
            
            <h3 style="color: #e2e8f0; margin-bottom: 1rem;">ü§ñ Create AI Visualization</h3>
            
            <form id="aiVisualizationForm">
                <div class="form-group">
                    <label for="aiRequest">Describe what you want to visualize</label>
                    <textarea id="aiRequest" rows="4" placeholder="e.g., Show me a line chart of settlement point prices over the last 24 hours" required></textarea>
                </div>
                <!-- Visualization type is now auto-detected by LangGraph -->
                <button type="submit" class="auth-btn" style="width: 100%; margin: 0;">Create Visualization</button>
                <div id="aiMessage"></div>
            </form>‚õìÔ∏è
        </div>
    </div>

    <script>
        let currentUser = null;
        let authToken = null;
        let dashboardSettings = [];
        let availablePanels = { predefined_panels: [], ai_generated_panels: [] };

        // Default public panel configurations for non-authenticated users
        const defaultPublicPanels = [
            {
                panel_id: 'chart1',
                panel_name: 'Real-Time Price Overview',
                panel_type: 'predefined',
                is_visible: true,
                panel_order: 1,
                iframe_src: 'http://52.4.166.16:3000/d-solo/bep90j9gjtb0gf/ercot?orgId=1&panelId=14&refresh=30s',
                panel_grid_column: 2
            },
            {
                panel_id: 'chart2',
                panel_name: 'System Available Capacity',
                panel_type: 'predefined',
                is_visible: true,
                panel_order: 2,
                iframe_src: 'http://52.4.166.16:3000/d-solo/bep90j9gjtb0gf/ercot?orgId=1&panelId=7&refresh=30s',
                panel_grid_column: 1
            },
            {
                panel_id: 'chart3',
                panel_name: 'Emergency & Outage Status',
                panel_type: 'predefined',
                is_visible: true,
                panel_order: 3,
                iframe_src: 'http://52.4.166.16:3000/d-solo/bep90j9gjtb0gf/ercot?orgId=1&panelId=1&refresh=30s',
                panel_grid_column: 1
            },
            {
                panel_id: 'chart4',
                panel_name: 'Reserve Capacity Overview',
                panel_type: 'predefined',
                is_visible: true,
                panel_order: 4,
                iframe_src: 'http://52.4.166.16:3000/d-solo/bep90j9gjtb0gf/ercot?orgId=1&panelId=12&refresh=30s',
                panel_grid_column: 2
            },
            {
                panel_id: 'chart5',
                panel_name: 'Settlement Point Prices',
                panel_type: 'predefined',
                is_visible: true,
                panel_order: 5,
                iframe_src: 'http://52.4.166.16:3000/d-solo/bep90j9gjtb0gf/ercot?orgId=1&panelId=13&refresh=30s',
                panel_grid_column: 2
            }
        ];

        // Generate 2-day time range URLs
        function generateTimeRangeUrl(baseUrl) {
            const now = Date.now();
            const twoDaysAgo = now - (2 * 24 * 60 * 60 * 1000);
            return `${baseUrl}&from=${twoDaysAgo}&to=${now}`;
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            authToken = localStorage.getItem('authToken');
            if (authToken) {
                getCurrentUser();
            } else {
                loadPublicDashboard();
            }
        });

        // Load public dashboard for non-authenticated users
        function loadPublicDashboard() {
            document.getElementById('dashboardTitle').textContent = 'Live Grid Monitoring';
            renderDashboard(defaultPublicPanels);
        }

        // Load user's personal dashboard
        async function loadUserDashboard() {
            try {
                const response = await fetch('/api/dashboard/settings', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const settings = await response.json();
                    dashboardSettings = settings;
                    
                    const userName = currentUser.first_name || currentUser.username;
                    document.getElementById('dashboardTitle').textContent = `${userName}'s Personal Dashboard`;
                    
                    if (settings.length > 0) {
                        renderDashboard(settings);
                    } else {
                        loadPublicDashboard();
                    }
                } else {
                    loadPublicDashboard();
                }
            } catch (error) {
                console.error('Error loading dashboard settings:', error);
                loadPublicDashboard();
            }
        }

        // FIXED: Load available panels for customization
        async function loadAvailablePanels() {
            if (!currentUser) return;
            
            try {
                console.log('üîÑ Loading available panels...');
                
                const response = await fetch('/api/dashboard/available-panels', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    availablePanels = await response.json();
                    console.log('‚úÖ Available panels loaded:', availablePanels);
                    console.log(`üìä Found ${availablePanels.predefined_panels.length} predefined panels`);
                    console.log(`ü§ñ Found ${availablePanels.ai_generated_panels.length} AI-generated panels`);
                } else {
                    console.error('‚ùå Failed to load available panels:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Error loading available panels:', error);
            }
        }

        // FIXED: Render dashboard with deduplication and detailed logging
        function renderDashboard(panels) {
            const container = document.getElementById('chartsContainer');
            container.innerHTML = '';

            console.log('üé® Rendering dashboard with panels:', panels);

            // FIXED: Deduplicate panels by panel_id and log details
            const uniquePanels = [];
            const seenPanelIds = new Set();
            const duplicatesFound = [];
            
            for (const panel of panels) {
                if (!seenPanelIds.has(panel.panel_id)) {
                    seenPanelIds.add(panel.panel_id);
                    uniquePanels.push(panel);
                    console.log(`‚úÖ Adding panel: ${panel.panel_id} - ${panel.panel_name} (${panel.panel_type})`);
                } else {
                    duplicatesFound.push(panel);
                    console.warn(`‚ö†Ô∏è Skipping duplicate panel: ${panel.panel_id} - ${panel.panel_name}`);
                }
            }

            if (duplicatesFound.length > 0) {
                console.warn(`‚ö†Ô∏è Found ${duplicatesFound.length} duplicate panels:`, duplicatesFound);
            }

            const visiblePanels = uniquePanels.filter(p => p.is_visible).sort((a, b) => a.panel_order - b.panel_order);
            
            console.log(`üìä Rendering ${visiblePanels.length} unique visible panels out of ${panels.length} total panels`);

            visiblePanels.forEach((panel, index) => {
                console.log(`üî® Creating chart card ${index + 1}: ${panel.panel_id} - ${panel.panel_name}`);
                
                // Validate panel data before creating card
                if (!panel.iframe_src) {
                    console.error(`‚ùå Panel ${panel.panel_id} has no iframe_src, skipping`);
                    return;
                }
                
                const chartCard = createChartCard(panel);
                
                if (panel.panel_grid_column === 2) {
                    const gridRow = document.createElement('div');
                    gridRow.className = 'charts-grid';
                    gridRow.appendChild(chartCard);
                    container.appendChild(gridRow);
                } else {
                    // Group side-by-side panels
                    let lastGrid = container.lastElementChild;
                    if (!lastGrid || lastGrid.children.length >= 2 || lastGrid.querySelector('.full-width-chart')) {
                        lastGrid = document.createElement('div');
                        lastGrid.className = 'charts-grid';
                        container.appendChild(lastGrid);
                    }
                    lastGrid.appendChild(chartCard);
                }
            });

            // Always add AI card (regardless of login status)
            const aiGrid = document.createElement('div');
            aiGrid.className = 'charts-grid';
            aiGrid.appendChild(createAICard());
            container.appendChild(aiGrid);
            
            console.log('‚úÖ Dashboard rendering complete');
        }

        // Create chart card from settings with validation and logging
        function createChartCard(panel) {
            console.log(`üî® Creating chart card for panel: ${panel.panel_id}`, panel);
            
            const chartCard = document.createElement('div');
            chartCard.className = `chart-card ${panel.panel_grid_column === 2 ? 'full-width-chart' : ''}`;
            chartCard.id = panel.panel_id;
            
            if (panel.panel_width) chartCard.style.width = panel.panel_width + 'px';
            if (panel.panel_height) chartCard.style.height = panel.panel_height + 'px';

            // Validate iframe_src
            if (!panel.iframe_src) {
                console.error(`‚ùå Panel ${panel.panel_id} has no iframe_src!`);
                console.error('Panel data:', panel);
                // Create an error card instead
                chartCard.innerHTML = `
                    <h3 class="chart-title">
                        ‚ùå ${panel.panel_name}
                        <div class="chart-controls">
                            <span style="color: #ef4444; font-size: 0.7rem;">Error: No URL</span>
                        </div>
                    </h3>
                    <div style="padding: 2rem; text-align: center; color: #ef4444;">
                        <p>Error: No iframe source URL found for this panel</p>
                        <p style="font-size: 0.8rem; margin-top: 1rem;">Panel ID: ${panel.panel_id}</p>
                    </div>
                `;
                return chartCard;
            }

            const urlWithTimeRange = generateTimeRangeUrl(panel.iframe_src);
            const isAIGenerated = panel.panel_type === 'ai_generated';
            
            console.log(`üì∫ Panel ${panel.panel_id} iframe URL: ${urlWithTimeRange}`);

            chartCard.innerHTML = `
                <h3 class="chart-title">
                    ${isAIGenerated ? 'ü§ñ ' : ''}${panel.panel_name}
                    <div class="chart-controls">
                        <button onclick="refreshChart('${panel.panel_id}')">‚Üª</button>
                        <button class="fullscreen-btn" onclick="openFullscreen('${panel.panel_id}')">‚õ∂</button>
                        ${currentUser ? `<button class="save-size-btn" onclick="saveChartSize('${panel.panel_id}')">üíæ</button>` : ''}
                        ${currentUser ? `<button class="hide-btn" onclick="hideChart('${panel.panel_id}')">‚úï</button>` : ''}
                    </div>
                </h3>
                <div class="iframe-container">
                    <iframe src="${urlWithTimeRange}" onload="console.log('‚úÖ Iframe loaded for ${panel.panel_id}')" onerror="console.error('‚ùå Iframe error for ${panel.panel_id}')"></iframe>
                </div>
            `;

            return chartCard;
        }

        // Create AI card with controls
        function createAICard() {
            const aiCard = document.createElement('div');
            aiCard.className = 'chart-card ai-card full-width-chart';
            aiCard.id = 'aiCard'; // Fixed ID to avoid conflicts
            
            const createButtonText = currentUser ? 'Create' : 'Sign in to Create';
            const createButtonAction = currentUser ? 'showAIModal()' : 'promptSignInForAI()';
            const clearButton = currentUser ? '<button class="clear-btn" onclick="clearAllVisualizations()">üóëÔ∏è Clear All</button>' : '';
            
            aiCard.innerHTML = `
                <h3 class="chart-title">
                    ü§ñ AI-Powered Visualizations
                    <div class="chart-controls">
                        <button onclick="${createButtonAction}">‚ú® ${createButtonText}</button>
                        ${clearButton}
                    </div>
                </h3>
                <div style="padding: 2rem; text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üé®</div>
                    <h4 style="color: #e2e8f0; margin-bottom: 1rem; font-size: 1.5rem;">Create Custom Visualizations</h4>
                    <p style="color: #94a3b8; margin-bottom: 2rem; max-width: 400px; margin-left: auto; margin-right: auto;">
                        ${currentUser ? 
                            'Describe what you want to see and our AI will generate a custom chart that gets added to your personal dashboard.' :
                            'Sign in to unlock AI-powered custom visualizations that persist in your personal dashboard.'
                        }
                    </p>
                    <button class="ai-create-btn" onclick="${createButtonAction}">
                        ${currentUser ? 'Get Started' : 'Sign In to Get Started'}
                    </button>
                </div>
            `;
            return aiCard;
        }

        // Authentication functions
        async function loadDocs() {
            if (!currentUser) {
                showAuthModal('login');
                return;
            }
            try {
                const resp = await fetch('/api/docs', {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                if (!resp.ok) throw new Error('Failed to load docs');
                const html = await resp.text();
                const w = window.open();
                w.document.write(html);
            } catch (e) {
                alert(e.message);
            }
        }

        function promptSignInForAI() {
            showAuthModal('login');
        }

        function showAuthModal(tab) {
            document.getElementById('authModal').style.display = 'block';
            switchTab(tab);
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }

        function switchTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                registerTab.classList.add('active');
                loginTab.classList.remove('active');
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
            }
        }

        // Dashboard customization functions
        function showDashboardModal() {
            document.getElementById('dashboardModal').style.display = 'block';
            loadPanelSettings();
        }

        function closeDashboardModal() {
            document.getElementById('dashboardModal').style.display = 'none';
        }

        function switchPanelsTab(type) {
            const predefinedTab = document.getElementById('predefinedTab');
            const aiGeneratedTab = document.getElementById('aiGeneratedTab');
            const predefinedPanels = document.getElementById('predefinedPanels');
            const aiGeneratedPanels = document.getElementById('aiGeneratedPanels');

            if (type === 'predefined') {
                predefinedTab.classList.add('active');
                aiGeneratedTab.classList.remove('active');
                predefinedPanels.style.display = 'block';
                aiGeneratedPanels.style.display = 'none';
            } else {
                aiGeneratedTab.classList.add('active');
                predefinedTab.classList.remove('active');
                aiGeneratedPanels.style.display = 'block';
                predefinedPanels.style.display = 'none';
            }
        }

        // FIXED: Load panel settings for customization
        async function loadPanelSettings() {
            console.log('üîÑ Loading panel settings for customization...');
            
            await loadAvailablePanels();
            
            const predefinedContainer = document.getElementById('predefinedPanels');
            const aiGeneratedContainer = document.getElementById('aiGeneratedPanels');
            
            predefinedContainer.innerHTML = '';
            aiGeneratedContainer.innerHTML = '';

            // Load predefined panels
            console.log('üìä Loading predefined panels...');
            availablePanels.predefined_panels.forEach(panel => {
                const setting = dashboardSettings.find(s => s.panel_id === panel.panel_id) || { ...panel, is_visible: false };
                
                const panelDiv = document.createElement('div');
                panelDiv.className = 'panel-settings';
                panelDiv.innerHTML = `
                    <h4>${panel.panel_name}</h4>
                    <div class="panel-type">üìä ERCOT Predefined Chart</div>
                    <div class="panel-toggle">
                        <input type="checkbox" id="${panel.panel_id}_visible" ${setting.is_visible ? 'checked' : ''}>
                        <label for="${panel.panel_id}_visible">Show on dashboard</label>
                    </div>
                `;
                predefinedContainer.appendChild(panelDiv);
            });

            // FIXED: Load AI-generated panels
            console.log('ü§ñ Loading AI-generated panels...');
            if (availablePanels.ai_generated_panels && availablePanels.ai_generated_panels.length > 0) {
                availablePanels.ai_generated_panels.forEach(panel => {
                    const setting = dashboardSettings.find(s => s.panel_id === panel.panel_id) || { ...panel, is_visible: false };
                    
                    const panelDiv = document.createElement('div');
                    panelDiv.className = 'panel-settings';
                    
                    // Clean up display name
                    const displayName = panel.panel_name.replace(/^AI: /, '');
                    
                    panelDiv.innerHTML = `
                        <h4>ü§ñ ${displayName}</h4>
                        <div class="panel-type">ü§ñ AI Generated ‚Ä¢ ${panel.created_at ? new Date(panel.created_at).toLocaleDateString() : 'Recent'}</div>
                        <div class="panel-toggle">
                            <input type="checkbox" id="${panel.panel_id}_visible" ${setting.is_visible ? 'checked' : ''}>
                            <label for="${panel.panel_id}_visible">Show on dashboard</label>
                        </div>
                        ${panel.request_text ? `<div style="color: #94a3b8; font-size: 0.8rem; margin-top: 0.5rem;">"${panel.request_text}"</div>` : ''}
                    `;
                    aiGeneratedContainer.appendChild(panelDiv);
                });
                
                console.log(`‚úÖ Loaded ${availablePanels.ai_generated_panels.length} AI-generated panels in customize tab`);
            } else {
                aiGeneratedContainer.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 2rem;">No AI-generated visualizations yet. Create some using the AI card!</p>';
                console.log('‚ÑπÔ∏è No AI-generated panels found');
            }
        }

        function saveDashboardSettings() {
            const allPanels = [...availablePanels.predefined_panels, ...availablePanels.ai_generated_panels];
            
            const panels = allPanels.map((panel, index) => {
                const isVisible = document.getElementById(`${panel.panel_id}_visible`)?.checked || false;
                const existingSetting = dashboardSettings.find(s => s.panel_id === panel.panel_id);
                
                return {
                    panel_id: panel.panel_id,
                    panel_name: panel.panel_name,
                    panel_type: panel.panel_type,
                    is_visible: isVisible,
                    panel_order: existingSetting?.panel_order || (index + 1),
                    panel_width: existingSetting?.panel_width || null,
                    panel_height: existingSetting?.panel_height || null,
                    panel_grid_column: panel.grid_column || panel.panel_grid_column || 1,
                    iframe_src: panel.iframe_src,
                    ai_visualization_id: panel.ai_visualization_id || null,
                    dashboard_uid: panel.dashboard_uid || null
                };
            });

            fetch('/api/dashboard/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ panels })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('dashboardMessage').innerHTML = '<div class="success-message">Personal dashboard settings saved!</div>';
                setTimeout(() => {
                    closeDashboardModal();
                    loadUserDashboard();
                }, 1000);
            })
            .catch(error => {
                document.getElementById('dashboardMessage').innerHTML = '<div class="error-message">Failed to save settings</div>';
            });
        }

        function resetDashboard() {
            if (!currentUser) return;
            
            if (confirm('Reset to default dashboard? This will remove all AI visualizations and customizations.')) {
                fetch('/api/dashboard/reset', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    dashboardSettings = [];
                    if (document.getElementById('dashboardModal').style.display === 'block') {
                        closeDashboardModal();
                    }
                    loadUserDashboard();
                })
                .catch(error => {
                    console.error('Error resetting dashboard:', error);
                });
            }
        }

        function saveChartSize(chartId) {
            if (!currentUser) return;
            
            const chartCard = document.getElementById(chartId);
            if (!chartCard) return;

            const existingPanel = dashboardSettings.find(p => p.panel_id === chartId);
            if (!existingPanel) return;

            const updatedPanel = {
                ...existingPanel,
                panel_width: chartCard.offsetWidth,
                panel_height: chartCard.offsetHeight
            };

            fetch('/api/dashboard/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ panels: [updatedPanel] })
            })
            .then(response => response.json())
            .then(data => {
                const controls = chartCard.querySelector('.chart-controls');
                const originalHtml = controls.innerHTML;
                controls.innerHTML = controls.innerHTML + ' <span style="color: #22c55e;">‚úì Saved</span>';
                setTimeout(() => {
                    controls.innerHTML = originalHtml;
                }, 2000);
            })
            .catch(error => {
                console.error('Error saving chart size:', error);
            });
        }

        function hideChart(chartId) {
            if (!currentUser) return;
            
            if (confirm('Hide this chart from your dashboard?')) {
                const existingPanel = dashboardSettings.find(p => p.panel_id === chartId);
                if (!existingPanel) return;

                const updatedPanel = {
                    ...existingPanel,
                    is_visible: false
                };
                
                fetch('/api/dashboard/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ panels: [updatedPanel] })
                })
                .then(response => response.json())
                .then(data => {
                    loadUserDashboard();
                })
                .catch(error => {
                    console.error('Error hiding chart:', error);
                });
            }
        }

        // Chart management functions
        function refreshChart(chartId) {
            const iframe = document.querySelector(`#${chartId} iframe`);
            if (iframe) {
                const urlWithTimeRange = generateTimeRangeUrl(iframe.src.split('&from=')[0]);
                iframe.src = urlWithTimeRange;
            }
        }

        function openFullscreen(chartId) {
            const iframe = document.querySelector(`#${chartId} iframe`);
            if (iframe) {
                let src = iframe.src;
                if (src.includes('?')) {
                    src += '&kiosk=tv';
                } else {
                    src += '?kiosk=tv';
                }
                window.open(src, '_blank', 'fullscreen=yes');
            }
        }

        // Debug functions for troubleshooting AI visualization issues
        async function debugDashboardEntries() {
            if (!currentUser) {
                promptSignInForAI();
                return;
            }
            
            try {
                console.log('üîç Fetching debug info for dashboard entries...');
                
                const response = await fetch('/api/ai/debug/dashboard-entries', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('üîç Debug data:', data);
                    
                    let message = `üìä Dashboard Debug Info:\n\n`;
                    message += `Total AI entries: ${data.total_ai_dashboard_entries}\n`;
                    message += `Duplicates found: ${data.duplicates_by_viz_id.length}\n`;
                    message += `Missing URLs: ${data.entries_missing_urls.length}\n\n`;
                    
                    if (data.has_duplicates) {
                        message += `üîÑ Duplicates by visualization ID:\n`;
                        data.duplicates_by_viz_id.forEach(dup => {
                            message += `- Viz ID ${dup.ai_visualization_id}: ${dup.count} entries\n`;
                        });
                        message += `\n`;
                    }
                    
                    if (data.has_missing_urls) {
                        message += `‚ùå Entries with missing URLs:\n`;
                        data.entries_missing_urls.forEach(entry => {
                            message += `- ${entry.panel_id}: ${entry.panel_name}\n`;
                        });
                        message += `\n`;
                    }
                    
                    message += `üìã All AI dashboard entries:\n`;
                    data.dashboard_entries.forEach((entry, index) => {
                        message += `${index + 1}. ${entry.panel_id} - ${entry.panel_name}\n`;
                        message += `   URL: ${entry.iframe_src ? 'Valid' : 'MISSING'}\n`;
                        message += `   Viz ID: ${entry.ai_visualization_id || 'None'}\n`;
                        message += `   Created: ${entry.created_at || 'Unknown'}\n\n`;
                    });
                    
                    alert(message);
                } else {
                    alert('‚ùå Failed to fetch debug info');
                }
            } catch (error) {
                console.error('‚ùå Debug error:', error);
                alert(`‚ùå Debug error: ${error.message}`);
            }
        }

        async function cleanupDuplicates() {
            if (!currentUser) {
                promptSignInForAI();
                return;
            }
            
            if (!confirm('üßπ This will remove duplicate and invalid AI dashboard entries. Continue?')) {
                return;
            }
            
            try {
                console.log('üßπ Cleaning up duplicate dashboard entries...');
                
                const response = await fetch('/api/ai/debug/cleanup-duplicates', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Cleanup result:', data);
                    
                    alert(`‚úÖ Cleanup completed!\n\nRemoved entries with no URL: ${data.removed_entries_no_url}\nRemoved duplicate entries: ${data.removed_duplicate_entries}\nTotal removed: ${data.total_removed}`);
                    
                    // Reload dashboard after cleanup
                    loadUserDashboard();
                } else {
                    alert('‚ùå Failed to cleanup duplicates');
                }
            } catch (error) {
                console.error('‚ùå Cleanup error:', error);
                alert(`‚ùå Cleanup error: ${error.message}`);
            }
        }

        // FIXED: Clear all AI visualizations
        async function clearAllVisualizations() {
            if (!currentUser) {
                promptSignInForAI();
                return;
            }
            
            if (!confirm('Are you sure you want to clear all AI visualizations? This will remove them from your dashboard permanently.')) {
                return;
            }
            
            try {
                console.log('üóëÔ∏è Clearing all AI visualizations...');
                
                const response = await fetch('/api/ai/visualizations/clear', {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ Clear successful:', data);
                    alert(`‚úÖ Successfully cleared ${data.visualizations_deleted} AI visualizations`);
                    
                    // Reload the dashboard to reflect changes
                    loadUserDashboard();
                } else {
                    const errorData = await response.text();
                    console.error('‚ùå Clear failed:', response.status, errorData);
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Error clearing visualizations:', error);
                alert(`‚ùå Failed to clear visualizations: ${error.message}`);
            }
        }

        // FIXED: AI Visualization form handler with request deduplication
        let isCreatingVisualization = false; // Prevent multiple simultaneous requests
        
        document.getElementById('aiVisualizationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!authToken) {
                showAuthModal('login');
                return;
            }

            // Prevent multiple simultaneous requests
            if (isCreatingVisualization) {
                console.log('‚ö†Ô∏è AI visualization creation already in progress, ignoring duplicate request');
                return;
            }

            const requestText = document.getElementById('aiRequest').value;
            // Visualization type is now auto-detected by LangGraph
            const messageDiv = document.getElementById('aiMessage');

            console.log('ü§ñ Creating AI visualization:', requestText);
            
            isCreatingVisualization = true;
            messageDiv.innerHTML = '<div style="color: #00d4ff;">üîÑ Creating AI visualization and adding to your dashboard...</div>';

            try {
                const response = await fetch('/api/ai/visualizations/langgraph', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        request_text: requestText
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    console.log('‚úÖ AI visualization response:', data);
                    
                    if (data.added_to_dashboard) {
                        messageDiv.innerHTML = '<div class="success-message">‚úÖ AI visualization created and added to your personal dashboard!</div>';
                        document.getElementById('aiRequest').value = '';
                        
                        // Wait a moment before reloading to ensure backend processing is complete
                        setTimeout(() => {
                            closeAIModal();
                            console.log('üîÑ Reloading dashboard to show new AI visualization...');
                            loadUserDashboard(); // Reload to show new chart
                        }, 2000);
                    } else {
                        messageDiv.innerHTML = '<div class="success-message">‚úÖ AI analysis completed, but dashboard creation failed. Check the logs.</div>';
                        setTimeout(() => {
                            closeAIModal();
                        }, 2000);
                    }
                } else {
                    console.error('‚ùå AI visualization failed:', data);
                    messageDiv.innerHTML = `<div class="error-message">‚ùå ${data.detail}</div>`;
                }
            } catch (error) {
                console.error('‚ùå AI visualization error:', error);
                messageDiv.innerHTML = '<div class="error-message">‚ùå Failed to create visualization. Please try again.</div>';
            } finally {
                // Reset the flag after request completes (success or failure)
                isCreatingVisualization = false;
            }
        });

        function showAIModal() {
            if (!currentUser) {
                promptSignInForAI();
                return;
            }
            document.getElementById('aiModal').style.display = 'block';
        }

        function closeAIModal() {
            document.getElementById('aiModal').style.display = 'none';
        }

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const messageDiv = document.getElementById('loginMessage');

            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = data.user;
                    updateAuthUI();
                    closeAuthModal();
                    loadUserDashboard();
                    messageDiv.innerHTML = '<div class="success-message">Login successful!</div>';
                } else {
                    messageDiv.innerHTML = `<div class="error-message">${data.detail}</div>`;
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error-message">Login failed. Please try again.</div>';
            }
        });

        // Register form handler
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('registerEmail').value;
            const username = document.getElementById('registerUsername').value;
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            const password = document.getElementById('registerPassword').value;
            const messageDiv = document.getElementById('registerMessage');

            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email,
                        username,
                        first_name: firstName,
                        last_name: lastName,
                        password
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.access_token;
                    localStorage.setItem('authToken', authToken);
                    currentUser = data.user;
                    updateAuthUI();
                    closeAuthModal();
                    loadUserDashboard();
                    messageDiv.innerHTML = '<div class="success-message">Registration successful!</div>';
                } else {
                    messageDiv.innerHTML = '<div class="error-message">${data.detail}</div>';
                }
            } catch (error) {
                messageDiv.innerHTML = '<div class="error-message">Registration failed. Please try again.</div>';
            }
        });

        // Get current user info
        async function getCurrentUser() {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    updateAuthUI();
                    loadUserDashboard();
                } else {
                    logout();
                }
            } catch (error) {
                console.error('Error getting user info:', error);
                logout();
            }
        }

        // Update authentication UI
        function updateAuthUI() {
            const authSection = document.getElementById('authSection');
            const dashboardActions = document.getElementById('dashboardActions');
            
            if (currentUser) {
                authSection.innerHTML = `
                    <span class="user-info">Welcome, ${currentUser.first_name || currentUser.username}!</span>
                    <button class="auth-btn logout-btn" onclick="logout()">Logout</button>
                `;
                dashboardActions.style.display = 'flex';
            } else {
                authSection.innerHTML = `
                    <button class="auth-btn" onclick="showAuthModal('login')">Login</button>
                    <button class="auth-btn" onclick="showAuthModal('register')">Sign Up</button>
                `;
                dashboardActions.style.display = 'none';
            }
        }

        // Logout function
        function logout() {
            currentUser = null;
            authToken = null;
            dashboardSettings = [];
            availablePanels = { predefined_panels: [], ai_generated_panels: [] };
            localStorage.removeItem('authToken');
            updateAuthUI();
            loadPublicDashboard();
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const authModal = document.getElementById('authModal');
            const aiModal = document.getElementById('aiModal');
            const dashboardModal = document.getElementById('dashboardModal');
            
            if (event.target === authModal) {
                closeAuthModal();
            }
            if (event.target === aiModal) {
                closeAIModal();
            }
            if (event.target === dashboardModal) {
                closeDashboardModal();
            }
        }

        // Auto-refresh all charts every 5 minutes
        setInterval(() => {
            const allCharts = document.querySelectorAll('.chart-card[id]');
            allCharts.forEach(chart => {
                const chartId = chart.id;
                if (chartId !== 'aiCard') {
                    refreshChart(chartId);
                }
            });
        }, 300000);

        console.log('üöÄ ERCOT Analytics Personal Dashboard System loaded');
    </script>
</body>
</html>